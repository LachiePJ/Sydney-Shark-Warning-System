"use strict";exports.id=499,exports.ids=[499],exports.modules={6004:(e,a,t)=>{t.d(a,{n:()=>r});let r={type:"FeatureCollection",features:[{type:"Feature",properties:{id:"sydney-harbour-inner",name:"Sydney Harbour (Inner)",description:"Inner harbour including Circular Quay to Middle Head",bomStations:{rainfall:"066062",waterTemp:"IDO71000/IDO71000_55.json",swell:"IDO71000/IDO71000_55.json"}},geometry:{type:"Polygon",coordinates:[[[151.205,-33.85],[151.225,-33.85],[151.245,-33.835],[151.265,-33.825],[151.28,-33.825],[151.28,-33.84],[151.265,-33.85],[151.245,-33.855],[151.225,-33.855],[151.205,-33.85]]]}},{type:"Feature",properties:{id:"sydney-harbour-outer",name:"Sydney Harbour (Outer)",description:"Outer harbour from Middle Head to North/South Heads",bomStations:{rainfall:"066062",waterTemp:"IDO71000/IDO71000_55.json",swell:"IDO71000/IDO71000_55.json"}},geometry:{type:"Polygon",coordinates:[[[151.265,-33.825],[151.28,-33.825],[151.285,-33.83],[151.285,-33.84],[151.28,-33.84],[151.265,-33.85],[151.265,-33.825]]]}},{type:"Feature",properties:{id:"manly",name:"Manly",description:"Manly Beach and surrounding areas",bomStations:{rainfall:"066062",waterTemp:"IDO71000/IDO71000_60.json",swell:"IDO71000/IDO71000_60.json"}},geometry:{type:"Polygon",coordinates:[[[151.285,-33.79],[151.295,-33.79],[151.295,-33.805],[151.285,-33.805],[151.285,-33.79]]]}},{type:"Feature",properties:{id:"bondi-bronte",name:"Bondi - Bront\xeb",description:"Bondi, Tamarama, and Bront\xeb beaches",bomStations:{rainfall:"066062",waterTemp:"IDO71000/IDO71000_60.json",swell:"IDO71000/IDO71000_60.json"}},geometry:{type:"Polygon",coordinates:[[[151.27,-33.885],[151.28,-33.885],[151.28,-33.905],[151.27,-33.905],[151.27,-33.885]]]}},{type:"Feature",properties:{id:"coogee-maroubra",name:"Coogee - Maroubra",description:"Coogee, Clovelly, and Maroubra beaches",bomStations:{rainfall:"066062",waterTemp:"IDO71000/IDO71000_60.json",swell:"IDO71000/IDO71000_60.json"}},geometry:{type:"Polygon",coordinates:[[[151.255,-33.915],[151.265,-33.915],[151.265,-33.955],[151.255,-33.955],[151.255,-33.915]]]}},{type:"Feature",properties:{id:"cronulla",name:"Cronulla",description:"Cronulla Beach and surrounding areas",bomStations:{rainfall:"066062",waterTemp:"IDO71000/IDO71000_60.json",swell:"IDO71000/IDO71000_60.json"}},geometry:{type:"Polygon",coordinates:[[[151.145,-34.045],[151.16,-34.045],[151.16,-34.065],[151.145,-34.065],[151.145,-34.045]]]}},{type:"Feature",properties:{id:"palm-beach",name:"Palm Beach",description:"Palm Beach and northern beaches",bomStations:{rainfall:"066062",waterTemp:"IDO71000/IDO71000_60.json",swell:"IDO71000/IDO71000_60.json"}},geometry:{type:"Polygon",coordinates:[[[151.315,-33.595],[151.33,-33.595],[151.33,-33.61],[151.315,-33.61],[151.315,-33.595]]]}}]}},9499:(e,a,t)=>{t.d(a,{D:()=>I});let r={waterTemp:20,rainfall48h:60,swellMin:1.8,swellMax:2.8,summerMonths:[10,11,0,1]},n={waterTemp:20,rainfall:25,swell:20,season:15,waterQuality:20},l=[{level:"Low",minScore:0,maxScore:20,color:"#10b981",guidance:"Conditions are favourable. Normal swimming precautions apply."},{level:"Moderate",minScore:21,maxScore:40,color:"#fbbf24",guidance:"Swim with caution. Avoid murky water and dawn/dusk periods."},{level:"High",minScore:41,maxScore:60,color:"#f59e0b",guidance:"Elevated risk. Stay in patrolled areas and avoid murky conditions."},{level:"Severe",minScore:61,maxScore:80,color:"#dc2626",guidance:"Serious risk. Swimming not recommended. Stay out of the water if possible."},{level:"Catastrophic",minScore:81,maxScore:100,color:"#7f1d1d",guidance:"DO NOT SWIM. All high-risk conditions are present."}];class s{constructor(e={}){this.thresholds={...r,...e.thresholds},this.weights={...n,...e.weights}}calculateRisk(e){let a=this.evaluateConditions(e),t=this.calculateScore(a),r=this.calculateConfidence(e),n=function(e){for(let a of l)if(e>=a.minScore&&e<=a.maxScore)return a;return l[0]}(t),s={conditionsMet:a,missingData:this.getMissingData(e),reasoning:this.generateReasoning(a,t)};return{level:n.level,score:t,color:n.color,guidance:n.guidance,explanation:s,confidence:r,timestamp:e.timestamp,debug:{rawInput:e}}}evaluateConditions(e){let a=[],t=e=>{if(!e)return"Unknown";let a=Math.floor((Date.now()-new Date(e).getTime())/6e4),t=Math.floor(a/60);return t>0?`${t}h ago`:a>0?`${a}min ago`:"Just now"};return a.push({name:"High Water Temperature",met:null!==e.waterTemp&&e.waterTemp>this.thresholds.waterTemp,value:e.waterTemp,threshold:`> ${this.thresholds.waterTemp}\xb0C`,weight:this.weights.waterTemp,source:e.sources?.waterTemp,timestamp:e.timestamp,dataAge:t(e.timestamp)}),a.push({name:"Heavy Rainfall (48h)",met:null!==e.rainfall48h&&e.rainfall48h>this.thresholds.rainfall48h,value:e.rainfall48h,threshold:`> ${this.thresholds.rainfall48h}mm`,weight:this.weights.rainfall,source:e.sources?.rainfall,timestamp:e.timestamp,dataAge:t(e.timestamp)}),a.push({name:"Swell Height in Risk Range",met:null!==e.swellHeight&&e.swellHeight>=this.thresholds.swellMin&&e.swellHeight<=this.thresholds.swellMax,value:e.swellHeight,threshold:`${this.thresholds.swellMin}m - ${this.thresholds.swellMax}m`,weight:this.weights.swell,source:e.sources?.swell,timestamp:e.timestamp,dataAge:t(e.timestamp)}),a.push({name:"Summer Season",met:e.isSummer,value:e.isSummer?"Yes":"No",threshold:"Nov-Feb",weight:this.weights.season,source:"System calculated",dataAge:"Current"}),a.push({name:"Poor Water Quality",met:"poor"===e.waterQuality,value:e.waterQuality,threshold:"Poor (runoff/turbidity)",weight:this.weights.waterQuality,source:"Derived from rainfall data",timestamp:e.timestamp,dataAge:t(e.timestamp)}),a}calculateScore(e){let a=0,t=0;for(let r of e)t+=r.weight,r.met&&(a+=r.weight);let r=a/t*100;return e.every(e=>e.met)?90:Math.round(r)}calculateConfidence(e){let a=[e.waterTemp,e.rainfall48h,e.swellHeight].filter(e=>null!==e).length;return 3===a&&"unknown"!==e.waterQuality?"high":a>=2?"medium":"low"}getMissingData(e){let a=[];return null===e.waterTemp&&a.push("Water Temperature"),null===e.rainfall48h&&a.push("Rainfall Data"),null===e.swellHeight&&a.push("Swell Height"),"unknown"===e.waterQuality&&a.push("Water Quality (proxy)"),a}generateReasoning(e,a){let t=e.filter(e=>e.met),r=t.length;return 0===r?"No elevated risk conditions are currently present.":1===r?`One risk factor detected: ${t[0].name}. Risk remains relatively low.`:2===r?`Two risk factors present: ${t.map(e=>e.name).join(" and ")}. Moderate caution advised.`:r===e.length?"ALL risk factors are present. Conditions are highly favourable for increased shark activity. Do not swim.":`Multiple risk factors detected (${r}/${e.length}). Exercise significant caution.`}static deriveWaterQuality(e){return null===e?"unknown":e>45?"poor":e>20?"poor":"good"}}var o=t(6004);let i={manly:{lat:-33.7969,lon:151.2887,name:"Manly"},bondi:{lat:-33.8915,lon:151.2767,name:"Bondi"},coogee:{lat:-33.9233,lon:151.2585,name:"Coogee"},maroubra:{lat:-33.9501,lon:151.2591,name:"Maroubra"},cronulla:{lat:-34.0576,lon:151.1532,name:"Cronulla"},palmBeach:{lat:-33.6005,lon:151.3216,name:"Palm Beach"},sydneyHarbour:{lat:-33.8688,lon:151.2093,name:"Sydney Harbour"}};async function c(e){try{let a=i[e],t=new URL("https://marine-api.open-meteo.com/v1/marine");t.searchParams.append("latitude",a.lat.toString()),t.searchParams.append("longitude",a.lon.toString()),t.searchParams.append("current","sea_surface_temperature,wave_height"),t.searchParams.append("timezone","Australia/Sydney");let r=new AbortController,n=setTimeout(()=>r.abort(),15e3),l=await fetch(t.toString(),{signal:r.signal,headers:{"User-Agent":"Sydney-Shark-Warning-System/1.0"}});if(clearTimeout(n),!l.ok)throw Error(`Marine API returned ${l.status}`);let s=await l.json(),o=new Date().toISOString(),c=s.current?.sea_surface_temperature?{value:s.current.sea_surface_temperature,timestamp:o,source:`Marine Data (${a.name})`}:null,h=s.current?.wave_height?{value:s.current.wave_height,timestamp:o,source:`Marine Data (${a.name})`}:null;return{temperature:c,waveHeight:h}}catch(a){return console.error(`Failed to fetch marine data for ${e}:`,a),{temperature:null,waveHeight:null}}}async function h(){let e={},a=Object.keys(i).map(async a=>{let t=await c(a);e[a]=t});return await Promise.all(a),e}class u{constructor(){this.cache=null}static getInstance(){return u.instance||(u.instance=new u),u.instance}getCache(){return this.cache}setCache(e){this.cache=e,console.log(`✅ Cache updated in memory: ${Object.keys(e.beaches).length} beaches`)}hasCache(){return null!==this.cache}}let m=u.getInstance();var d=t(5311);let p=null;function g(){if(p)return p;let e=process.env.UPSTASH_REDIS_REST_URL,a=process.env.UPSTASH_REDIS_REST_TOKEN;return e&&a?(p=new d.s({url:e,token:a}),console.log("✅ Upstash Redis connected"),p):(console.warn("⚠️  Upstash Redis not configured - data will not persist"),null)}async function w(e){try{let a=g();if(!a)return!1;return await a.set("shark-cache",JSON.stringify(e)),console.log("✅ Saved to Redis:",{beaches:Object.keys(e.beaches).length,lastFetch:e.lastFetch}),!0}catch(e){return console.error("❌ Redis save failed:",e),!1}}async function y(){try{let e=g();if(!e)return null;let a=await e.get("shark-cache");if(!a)return console.log("ℹ️  No data in Redis yet"),null;let t=JSON.parse(a);return console.log("✅ Loaded from Redis:",{beaches:Object.keys(t.beaches).length,lastFetch:t.lastFetch}),t}catch(e){return console.error("❌ Redis load failed:",e),null}}function f(){return!!(process.env.UPSTASH_REDIS_REST_URL&&process.env.UPSTASH_REDIS_REST_TOKEN)}var b=t(2048),S=t(5315),v=t.n(S);let D=v().join(process.cwd(),"data","cache.json"),O={"sydney-harbour-inner":"sydneyHarbour","sydney-harbour-outer":"sydneyHarbour",manly:"manly","bondi-bronte":"bondi","coogee-maroubra":"coogee",cronulla:"cronulla","palm-beach":"palmBeach"};class I{constructor(){this.cache=null,this.riskEngine=new s}async fetchBeachRainfall(e,a){try{let t=new URL("https://api.open-meteo.com/v1/forecast");t.searchParams.append("latitude",e.toString()),t.searchParams.append("longitude",a.toString()),t.searchParams.append("hourly","precipitation"),t.searchParams.append("timezone","Australia/Sydney"),t.searchParams.append("past_days","2"),t.searchParams.append("forecast_days","1");let r=await fetch(t.toString());if(!r.ok)return null;let n=await r.json();if(n.hourly?.precipitation){let e=Date.now()-1728e5,a=0;return n.hourly.time.forEach((t,r)=>{new Date(t).getTime()>=e&&(a+=n.hourly.precipitation[r]||0)}),a}return null}catch(e){return console.error("Failed to fetch rainfall:",e),null}}async refreshData(){console.log("Fetching beach-specific marine and weather data...");try{let e=await h(),a={},t={manly:{lat:-33.7969,lon:151.2887},bondi:{lat:-33.8915,lon:151.2767},coogee:{lat:-33.9233,lon:151.2585},maroubra:{lat:-33.9501,lon:151.2591},cronulla:{lat:-34.0576,lon:151.1532},palmBeach:{lat:-33.6005,lon:151.3216},sydneyHarbour:{lat:-33.8688,lon:151.2093}},r=Object.entries(t).map(async([e,a])=>{let t=await this.fetchBeachRainfall(a.lat,a.lon);return{beachKey:e,rainfall:t}}),n=await Promise.all(r);Object.keys(t).forEach(t=>{let r=e[t],l=n.find(e=>e.beachKey===t);a[t]={temperature:r?.temperature?.value||null,waveHeight:r?.waveHeight?.value||null,rainfall48h:l?.rainfall||null,timestamp:new Date().toISOString()},console.log(`✓ ${t}: Temp=${a[t].temperature}\xb0C, Rain=${a[t].rainfall48h}mm, Waves=${a[t].waveHeight}m`)}),this.cache={beaches:a,lastFetch:new Date().toISOString()},await this.saveCache(),console.log("✓ Beach-specific data successfully fetched")}catch(e){throw console.error("Failed to refresh beach data:",e),e}}async getRiskInputForZone(e){await this.ensureCacheLoaded();let a=O[e.id]||"sydneyHarbour",t=this.cache?.beaches?.[a],n=new Date,l=n.getMonth(),o=r.summerMonths.includes(l),i=s.deriveWaterQuality(t?.rainfall48h??null);return{waterTemp:t?.temperature??null,rainfall48h:t?.rainfall48h??null,swellHeight:t?.waveHeight??null,isSummer:o,waterQuality:i,timestamp:t?.timestamp||n.toISOString(),sources:{waterTemp:"Open-Meteo Marine API",rainfall:"Open-Meteo Weather API (BoM-backed)",swell:"Open-Meteo Marine API"}}}async calculateAllZoneRisks(){let e=[];for(let a of o.n.features){let t=await this.getRiskInputForZone(a.properties),r=this.riskEngine.calculateRisk(t);e.push({...r,zoneId:a.properties.id,zoneName:a.properties.name})}return e}async ensureCacheLoaded(){if(this.cache)return;if(f()){let e=await y();if(e&&e.beaches&&Object.keys(e.beaches).length>0){this.cache=e;let a=Date.now()-new Date(this.cache.lastFetch).getTime();console.log(`✅ Loaded from Redis (${Math.round(a/1e3/60)}min old, ${Object.keys(this.cache.beaches).length} beaches)`);let t=Object.keys(this.cache.beaches)[0],r=this.cache.beaches[t];console.log(`   Sample data (${t}):`,{temp:r.temperature,rainfall:r.rainfall48h,waves:r.waveHeight});return}}let e=m.getCache();if(e){this.cache=e;let a=Date.now()-new Date(this.cache.lastFetch).getTime();console.log(`✓ Loaded from memory singleton (${Math.round(a/1e3/60)}min old, ${Object.keys(this.cache.beaches).length} beaches)`);return}try{let e=await b.promises.readFile(D,"utf-8"),a=JSON.parse(e),t=a.beaches&&Object.keys(a.beaches).length>0?Object.values(a.beaches)[0]:null;if(t&&(null!==t.temperature||null!==t.rainfall48h||null!==t.waveHeight)){this.cache=a,m.setCache(a),console.log("✓ Loaded from filesystem, saved to singleton");return}}catch(e){console.log("ℹ️  No filesystem cache available")}console.warn("⚠️  NO CACHE AVAILABLE - Call /api/refresh to fetch live data"),this.cache={beaches:{},lastFetch:new Date(0).toISOString()}}async saveCache(){if(this.cache){f()?await w(this.cache)&&console.log("✅ Data persisted to Redis - will survive across requests!"):console.warn("⚠️  Redis not configured - data will not persist between requests"),m.setCache(this.cache);try{await b.promises.mkdir(v().dirname(D),{recursive:!0}),await b.promises.writeFile(D,JSON.stringify(this.cache,null,2)),console.log("✓ Cache saved to file")}catch(e){console.log("ℹ️  Could not save to file (expected on Vercel)")}}}getDataFreshness(){if(!this.cache)return"degraded";let e=Date.now()-new Date(this.cache.lastFetch).getTime();return e<18e5?"current":e<36e5?"stale":"degraded"}getMetricsStatus(){if(!this.cache)return{available:[],missing:["All metrics"]};let e=[],a=[];return Object.values(this.cache.beaches).some(e=>null!==e.temperature||null!==e.rainfall48h||null!==e.waveHeight)?(e.push("Beach-specific ocean temperature"),e.push("Beach-specific rainfall"),e.push("Beach-specific wave height")):a.push("All beach data"),{available:e,missing:a}}getBeachData(e){return this.cache?.beaches[e]||null}}}};